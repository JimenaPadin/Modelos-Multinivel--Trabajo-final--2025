---
title: "Recuperación funcional"
subtitle: |
          | Proyecto final
          | Introducción a los Modelos Multinivel
author: 
  - 'Bajac, Matías'
  - 'Padín, Jimena'
  - 'Viscailuz, Luciana'
date: "2025"
output: bookdown::pdf_document2
bibliography: referencias.bib
nocite: '@*'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(readxl)
library(tidyverse)
library(rstatix)# para hacer ANOVA RM
library(GGally)
library(lme4)
library(lmerTest) #para incluir los p valores
library(kableExtra)
library(performance)
library(knitr)
```

```{r}
data <- read_xlsx('recuperacion_funcional.xlsx') %>% filter(id!=53)
```

\newpage

# Introducción

El estado físico y funcional del cuerpo humano desempeña un papel central en la calidad de vida de un individuo. A partir de cierta edad se producen cambios fisiológicos que afectan a varios sistemas de forma progresiva, entre ellos el musculo-esquelético. La disminución de la densidad osea incrementa la fragilidad en los huesos y favorece la aparición ante impactos relativamente leves. Este suceso se ve acelerado particularmente en mujeres tras la menopausia. Paralelamente, la pérdida de masa muscular, la reducción de reflejos y el deterioro del control motor y del equilibrio contribuyen a un mayor riesgo de caídas en adultos mayores.

En adultos mayores, lesiones de este índole afectan directamente su autonomía y capacidad para realizar actividades básicas de la vida diaria. La recuperación funcional posterior a estos eventos es un proceso complejo influido por factores individuales (edad, sexo), condiciones de vida y el tratamiento recibido, ya sea fisioterapia u opciones quirúrgicas.

Debido al componente dependiente de los datos, dado a que estos resultan ser múltiples mediciones de un mismo individuo, contar con herramientas que permitan evaluar la evolución funcional de los pacientes resulta fundamental. Medidas estandarizadas como el Índice de Barthel permiten cuantificar el nivel de independencia antes y después del traumatismo, y constituyen un insumo valioso para estudiar trayectorias de recuperación. Los modelos multinivel representan una estrategia estadística adecuada para analizar datos longitudinales, capturar variabilidad individual en los procesos de cambio y evaluar el efecto diferencial de los tratamientos, de acuerdo con los objetivos del estudio presentado en este informe.




# Datos

```{r, eval=F}
data$id %>% unique() %>% length()
```

Los datos fueron proporcionados por el docente a cargo de la unidad curricular. Se cuenta con información longitudinal de 327 adultos mayores que sufrieron un traumatismo de muñeca, producto de una caída. Para cada individuo se registran siete variables vinculadas a factores personales y el contexto temporal de la medición. Se excluyó un individuo que presentaba dos fracturas en años distintos sin información funcional previa suficiente para reconstruir una trayectoria longitudinal consistente.

## Variables estáticas

```{r, eval=F}
data$edad %>% summary()
```

```{r fig.height = 2.7, fig.width = 4, include=F}
data_id <- data %>% 
  distinct(id, .keep_all = TRUE)

ggplot(data_id, aes(x = edad)) +
  geom_histogram(bins = 15, fill = "#20A387FF", color = "black")+
   theme_bw()
ggsave('plots/edades.pdf')
```

```{=tex}
\begin{wrapfigure}{R}{4in}
  \includegraphics{plots/edades.pdf}
  \caption{Distribución de la edad en la muestra.}
  \vspace{-10pt}
\end{wrapfigure}
```

Diversos estudios han documentado que la densidad mineral ósea disminuye progresivamente con la edad. En particular, @zhang2010epidemiology señalan que la pérdida de densidad ósea se intensifica en la sexta década de vida, lo que incrementa el riesgo a fracturas. En nuestro conjunto de datos, los individuos presentan una edad media de 83.5 años, con un rango entre 65 y 101 años, valores claramente por encima de este umbral crítico. Por lo tanto, la edad adquiere un rol clínicamente relevante en el análisis de la recuperación funcional.

Si observamos la variabilidad de la muestra mediante un histograma, la mayoría de las personas que ingresaron al tratamiento tienen entre 80 y 90 años.

```{r, eval=F}
(data$sexo %>% table())/nrow(data)
```

En cuanto al género, la proporción de mujeres en la muestra es considerablemente mayor (80%), lo cual es consistente con la evidencia epidemiológica: tras la menopausia, la disminución abrupta de estrógenos acelera la pérdida de densidad mineral ósea, aumentando la fragilidad del sistema musculo-esquelético y, por ende, la probabilidad de sufrir fracturas por caída [@riggs1986involutional]. Por otro lado, la literatura también muestra diferencias significativas en la recuperación funcional según el género. @dimonaco2012men encuentra en su estudio que los hombres presentan peores resultados funcionales que las mujeres, por lo que resulta pertinente incluir el género como covariable a nivel individual en los modelos.

```{r, eval=F}
(data$tratamiento %>% table())/nrow(data)
```

Respecto al tratamiento recibido, la elección entre tratamiento quirúrgico y fisioterapia tras una fractura de muñeca depende tanto de las características de la lesión como de las características clínicas del paciente. En general, las fracturas estables mediante inmovilización seguida de fisioterapia, mientras que la cirugía se reserva para fracturas inestables. En nuestra muestra, el 37% de los pacientes recibió tratamiento conservador y el 63% tratamiento quirúrgico.

```{r, eval=F}
(data$domicilio %>% table())/nrow(data)
```

Finalmente, la condición habitacional constituye un factor relevante en la recuperación funcional de adultos mayores. Vivir en el propio domicilio suele asociarse a mayor autonomía y una rutina previa más estable, lo que favorece la re-adquisición de habilidades motoras y funcionales. Por el contrario, residir en un hogar o institución puede reflejar una situación de mayor dependencia previa o menor movilidad, elementos que tienden a enlentecer la recuperación tras una fractura. En nuestros datos, el 69% de los pacientes residía en su domicilio y el 31% en instituciones, por lo que esta variable se incorpora como covariable a nivel individual para capturar diferencias en el nivel funcional previo y en el apoyo disponible durante el proceso de rehabilitación.

## Variables temporales

```{r}
data <- data %>% 
   mutate(momento = factor(momento,
                           levels=c('previo', 'ingreso', 
                                   '1 mes', '3 meses', 
                                   '12 meses', '24 meses')))
```

La variable que determina el tiempo donde se releva la información y le que otorga estructura longitudinal al conjunto de datos, `momentos`, establece tiempos de medición previos a la lesión, al momento de ingreso al sistema hospitalario y posteriormente a los 1, 3, 12 y 24 meses del evento, siendo las dos primeras mediciones disponibles para todos los individuos, mientras que las siguientes se registran de forma más esporádica.

```{r}
data$momento %>% table() %>% t() %>%  kable() %>%
   kable_styling(latex_options = 'HOLD_position')
```

Para estos momentos se releva la variable `barthel`. Como se establece por @mahoney1965barthel, el índice de Barthel es un índice simple de independencia para evaluar la capacidad de un paciente con un trastorno neuro-muscular o musculo-esquelético para cuidar de sí mismo. Los valores asignados a cada ítem se basan en el tiempo y la cantidad de asistencia física real requerida si un paciente no puede realizar la actividad.

```{r plot1, warning=F, fig.cap = 'Boxplot del índice de Barthel para diferentes momentos en relación a la lesión.', fig.height=2.5, fig.width=5}
data %>% ggplot()+
   geom_boxplot(aes(x=momento, y=barthel, fill=momento))+
   theme(legend.position = 'none')+
   theme_bw()+scale_fill_viridis_d()
```

En la Figura \@ref(fig:plot1) se muestra la distribución del Índice de Barthel en cada uno de los momentos de medición, con el objetivo de obtener una primera impresión de la evolución funcional de los pacientes. Se observa que, antes de la lesión, los individuos presentan niveles elevados de independencia funcional, en general por encima de 75 puntos. Tras el ingreso hospitalario, el puntaje disminuye de forma marcada, reflejando el estado físico asociado al evento. A partir del primer mes, los valores comienzan a incrementarse nuevamente, acompañando el proceso de recuperación. Entre el mes y dos años del incidente, la varianza del estado físico de los pacientes aumenta bastante, en comparación con los dos momentos del tiempo anteriores.

```{r}
b_prev <- data %>% filter(momento=='previo') %>% 
   mutate(b_prev = barthel) %>% select(id,b_prev) %>% unique()
b_ing <- data %>% filter(momento=='ingreso') %>% 
   mutate(b_ing = barthel) %>% select(id,b_ing) %>% unique()
data <- data %>% left_join(b_prev, by='id')%>% left_join(b_ing, by='id')
```

Por ultimo, la variable `recuperacion`, definida como $recuperacion = \frac{barthel_{actual}-barthel_{ingreso}}{barthel_{previo}-barthel_{ingreso}}$, se encuentra disponible para todos los momentos de medición excepto para el momento previo a la lesión dado que la expresión carece de interpretación clínica. Dado a su composición la misma se encuentra altamente relacionada con `barthel`:

```{r, warning=F}
data |>filter(momento!='previo') %>% 
  group_by(momento) |>
  summarise(r_barthel = cor(barthel,recuperacion,use = "complete.obs")) %>% t() %>% kable() %>% kable_styling(latex_options = 'HOLD_position')
```

A continuación, se presenta un segundo gráfico con la evolución en el tiempo de diez de los pacientes. Se identifica que todos comparten el mismo punto inicial, donde la tasa de recuperación al ingreso en el hospital vale 0. Esto tiene sentido ya que es el momento en el que sufrieron el traumatismo, previo a comenzar el tratamiento.

Se puede observar que las pendientes de las trayectorias difieren, y que, además, hay algunas más largas que otras, indicando que hay pacientes a los que no se les realizó un seguimiento continuo en el tiempo o que abandonaron el tratamiento.

```{r,fig.height=3.5, fig.cap='Trayectorias individuales de recuperación funcional para una muestra de pacientes seleccionados.'}
data %>% filter(id%in%c(1:10), momento!='previo') %>% ggplot()+
   geom_line(aes(x=momento, y=recuperacion, group = factor(id),
                 color=factor(id)))+
   geom_point(aes(x=momento, y=recuperacion, group = factor(id),
                 color=factor(id)))+
   labs(color='id')+
   theme_bw()+
   scale_color_viridis_d()
```

\newpage
 
# Metodología

Al trabajar con medidas repetidas, hay varios modelos posibles, entre ellos el RM – ANOVA, el cual es una adaptación del modelo ANOVA para medidas repetidas. Este no es el que se utilizó para el presente análisis, ya que supone que los datos deben estar balanceados, y como se mencionó anteriormente, en los datos disponibles esto no sucede.

Otro modelo posible, y con el que se decidió trabajar es el Modelo de Efectos Mixtos (LME), debido a que es mucho más flexible con respecto a los supuestos y presenta varias ventajas con respecto al modelo anterior.

Dado al tipo de datos, se identifica a los individuos y sus variables como el nivel 2 ($i$), mientras que las observaciones para cada individuo son de nivel 1 ($t$).

## Descripción de las variables 

Para la creación de modelos se establece como variable dependiente la recuperación del paciente, `recuperacion`. Previo a crear los modelos, se realizaron algunos ajustes sobre los datos:

-   Dado que al utilizar `recuperacion` como variable dependiente las observaciones de momento previo carecen de interpretación, las mismas fueron excluidas del análisis longitudinal. En su lugar se agrega una variable `b_prev` que indica el valor de índice de Barthel previo a la lesión. La misma se va a centrar respecto a su media (84.3578).

```{r}
# ya se hizo antes, en datos sobre momentos para verificar como se creaba recuperación
data %>% filter(momento=='previo') %>% summarise(mod=mean(barthel))#30
data <- data %>% filter(momento!='previo')
data$b_prev <- data$b_prev - 84.3578	
```

-   Dado que `recuperacion` se establece en 0 al momento del ingreso, mantener dicho momento produciría una constante sin interpretación sustantiva y dificultaría la interpretación de la variabilidad entre sujetos. Se decide excluir dichas observaciones y, en cambio, agregar una variable `b_ing` que indica el valor de índice de Barthel al momento del ingreso. La misma se va a centrar respecto a su moda (30). Dado a que estamos sacando esta observación y que los únicos momentos que estaban para todos los individuos eran el previo y el ingreso, actualmente se va a modelar para 300 individuos.

```{r, include=F}
# ya se hizo antes, en datos sobre momentos para verificar como se creaba recuperación
mode <- function(x) {
  return(as.numeric(names(which.max(table(x)))))
}
data %>% filter(momento=='ingreso') %>% summarise(mod=mode(barthel))#30
data <- data %>% filter(momento!='ingreso')
data$b_ing <- data$b_ing - 30
```

-   Considerando los cambios previos, la primera observación longitudinal se define en el momento _1 mes_. Si se define este como momento 0, permite una mejor interpretación de las constantes. Es por ello que la variable `momento2`, tomando en cuenta los meses transcurridos, se codifica {0, 2, 11, 23} para los momentos 1 mes, 3 meses, 12 meses y 24 meses, respectivamente.

```{r}
data = data %>%  
   mutate(momento2 = case_when(momento == "1 mes" ~ 0,
                              momento == "3 meses" ~ 2,
                              momento == "12 meses" ~ 11,
                              momento == "24 meses" ~ 23,
                              TRUE ~ NA_real_))
```

-   Respecto a la edad, siguiendo la literatura que indica el umbral critico referente a la densidad osea, se decide centrar la variable respecto a 60, con el fin que la interpretación de la constante refiera a la recuperación promedio en el umbral, y varíe para cada año por sobre el mismo ($edad2 = edad-60$).

```{r}
data <- data %>% 
   mutate(edad2 = edad - 60,
          tratamiento = as.factor(tratamiento),
          domicilio = as.factor(domicilio),
          sexo = as.factor(sexo),
          id = as.factor(id))
```

Por lo que las variables a seleccionar para ajustar el modelo son:

```{=tex}
\begin{table}[h]
\begin{tabular}{llll}
\hline
\textbf{Variable} & \textbf{Descripción} & \textbf{Valores} & \textbf{Nivel}\\ 
\hline

recuperacion & Variable dependiente & Continua, rango[-0.67,1.60] & nivel 1\\

tratamiento & Variable categórica que indica el típo de & cirugía o fisioterapia & nivel 2\\
&tratamiento que es sometido el paciente luego de &&\\
&la lesión &&\\

domicilio & Variable dummy que indica si el individuo hizo & si o no & nivel 2\\
& la recuperacion en su domicilio o en una institución & &\\

sexo & Varibale que indica el sexo del individuo & M o F & nivel 2\\

momento2 & Variable que toma como referencia el primer & 0, 2, 11, 23 & nivel 1\\
& mes luego del ingreso, metrica temporal & &\\

edad2 & Variable de edad de los individuos a la hora & rango[5,41] & nivel 2\\
& del ingreso, centrada en 60 años & & \\

b\_prev & Indice de Barthel previo a la lesion & rango[0,100] & nivel 2\\

b\_ing & Indice de Barthel al momento del ingreso & rango[0,100] & nivel 2\\

\hline
\end{tabular}
\caption{Variables a utilizar en los modelos.}
\label{tab:variables}
\end{table}
```




Nota: Se decidió no incorporar la variable Barthel al modelo debido a que como se mencionó anteriormente, esta se utiliza para construir la variable dependiente, por lo que el incluirla en el modelo llevaría a que absorba el efecto de las demás variables y se generen interpretaciones erróneas.



## Modelado

Se comienza por discernir la estructura apropiada de la matriz $\pmb D$. Bajo la hipótesis nula, se asume que ningún efecto aleatorio $k$ tiene un aporte significativo al modelo (modelo lineal):

\begin{equation}
H_0) \; \pmb D_i = 
\begin{bmatrix}
\pmb D_{q\times q} & \pmb 0_{q\times k}\\
\pmb 0_{k\times q} & \pmb 0_{k\times k}
\end{bmatrix}
\end{equation}

A partir de los modelos ajustados con `lmer(REML = FALSE)`, la significación de los componentes de varianza se evalúa empleando la mezcla de distribuciones propuesta por @Stram1994.

Una vez establecida la estructura de $\pmb D$, se crearon diversos modelos LME utilizando la función `lmer(`) del paquete `lme4`, además se aplicó la corrección de los grados de libertad de Kenward-Roger, la cual presenta ventajas sobre la corrección Satterthwait especialmente en muestras pequeñas y datos desbalanceados.

\newpage

# Resultados

## Estructura de la matriz $\pmb D$

```{r, echo=T, warning=F}
mod0 <- lm(recuperacion ~ 1, data=data)
mod1 <- lmer(recuperacion ~ 1 + (1|id), data=data, REML=F)
mod2 <- lmer(recuperacion ~ 1 + (momento2|id), data=data, REML=F)
```

```{r, echo=T}
L0 <- logLik(mod0)
L1 <- logLik(mod1)
LRT <- -2*(L0 - L1)
0.5*pchisq(LRT, 1, lower.tail = FALSE)
```

El p-valor obtenido para evaluar la inclusión de contantes aleatorias indica que dichos efectos son estadísticamente significativos.

```{r, echo=T}
L2 <- logLik(mod2)
LRT <- -2*(L1 - L2)
pchisq(LRT,c(1,2),lower.tail = FALSE) |> mean()
```
Dado el resultado del test se adopta como estructura aleatoria final un modelo con constantes y pendientes aleatorias. El modelo jerárquico resultante es:

$$recuperacion_{it} = \beta_{0i} + \beta_{1i}momento2_{it} + \varepsilon_{it} \qquad i=1,2,...,327\quad t=0,2,11,23$$
$$\beta_{0i}=\gamma_{00}+\eta_{0i}$$
$$\beta_{1i}=\gamma_{10}+\eta_{1i}$$

```{r, echo=T}
# Modelo Base
mod0 <- lmer(recuperacion ~ 1 + (momento2|id), data=data)
```

Primeramente veremos de agregar `momento2` como efecto fijo, dado al factor longitudinal.

```{r, echo=T}
mod1 = lmer(recuperacion ~ momento2 + (momento2|id), data=data)
anova(mod0,mod1)
```

El test de máxima verosimilitud indica que toda momentos no aporta mayor información al modelo de la que ya esta aportando con pendientes aleatorias.


## Inclusión de covariables al modelo

Se comienza un modelo base, donde hay un intercepto y pendiente aleatoria para cada paciente. Luego, se incorporan como efectos fijos otras variables como la edad al momento del traumatismo, el sexo y domicilio del paciente, que como se mencionó anteriormente, la literatura las identifica como variables relevantes.

```{r, echo=T, warning=F}
mod2 = lmer(recuperacion ~ sexo + (momento2|id), data= data) #agregamos sexo
anova(mod0,mod2) #no significativo

mod3 = lmer(recuperacion ~ edad2 + (momento2|id), data= data) #agregamos edad
anova(mod0,mod3) #muy significativo, se acepta el nuevo modelo

mod4 = lmer(recuperacion ~ edad2 + domicilio + (momento2|id), 
            data= data) #agregamos edad y domicilio
anova(mod3,mod4) #significativo a mas del 95%, aceptamos el modelo nuevo
```

De los modelos anteriores, se detecta que en contradicción con lo que la literatura señalaba, el genero del paciente no es significativo para explicar la recuperación del mismo, por lo que se decide prescindir de esta variable.

Además, se decide incluir la variable tratamiento como efecto fijo. Al incorporarla de esta forma se puede contrastar el objetivo planteado, identificar el efecto del tratamiento sobre la recuperación en si mismo, es decir, detectar si la evolución en la recuperación de los pacientes varía según el tratamiento proporcionado.

```{r, echo=T, warning=F}
mod5= lmer(recuperacion ~ edad2 + domicilio + tratamiento + (momento2|id),
           data= data) #agregamos tratamiento a edad y domicilio
anova(mod4,mod5) #aceptamos el nuevo modelo
```

Como era de esperarse, el test de máxima verosimilitud nos indica que tratamiento agrega mucha información al modelo.

Se quiere ver si las variables creadas a partir de las observaciones de los momentos eliminados (previo e ingreso) pueden aportar una mayor calidad de ajuste.

```{r, echo=T}
mod6= lmer(recuperacion ~ edad2 + domicilio + tratamiento + b_prev + (momento2|id), data= data)
anova(mod5,mod6) # no significativo

mod7 = lmer(recuperacion ~ edad2 + domicilio + tratamiento + b_ing + (momento2|id), data= data)
anova(mod5,mod7) # significativo al 95%
```

La variable que indica el indice de Barthel del cual inicialmente deben recuperarse los pacientes parece estar agregando una mayor calidad de ajuste, aunque en menos proporción a las variables anteriores. Sin embargo el estado previo a la lesión no proporciona nada.

Se va a probar la interacción entre ambas variables, dado a que cambios abruptos en la calidad de vida pueden ser mas difíciles de recuperarse que aquellos leves:

```{r, echo=T}
mod8= lmer(recuperacion ~ edad2 + domicilio + tratamiento + b_ing + b_ing:b_prev + 
              (momento2|id), data= data)
anova(mod7,mod8) # no significativo
```

Por ultimo se va a probar la interacción entre `tratamiento:momento` y `edad:momento`, dado que a pesar que el tipo de tratamiento es decidido a causa del estado de la lesión principalmente, es probable que para cierto tratamiento tenga una rápida recuperación en los primeros meses y después se enlentezca mientras que el otro puede ser mas paulatino.

```{r, warning=F, echo=T}
mod9= lmer(recuperacion ~ edad2 + domicilio + tratamiento + b_ing + 
              tratamiento:momento2 + (momento2|id), data= data)
anova(mod7,mod9) # no significativo

mod10= lmer(recuperacion ~ edad2 + domicilio + tratamiento + 
               b_ing + edad2:momento2 + (momento2|id), data= data)
anova(mod7,mod10) # significativo al 90%, no 95%, no aceptamos
```

Dado que ninguno de los cambios propuestos fueron aceptados por el test de verosimilitud al 95%, procedemos a ver el summary del posible modelo final.

```{r, echo=T}
summary(mod7, ddf = "Kenward-Roger")
```

## Modelo final

Dado las variables del modelo final, la formula jerárquica toma la siguiente forma:

$$recuperacion_{it} = \beta_{0i} + \beta_{1i}momento2_{it} + \varepsilon_{it} \qquad i=1,2,...,327\quad t=0,2,11,23$$
$$\beta_{0i}=\gamma_{00}+\gamma_{01}edad2_{i}+\gamma_{02}domicilio_{i}+\gamma_{03}tratamiento_i + \gamma_{04}b\_ing_i + \eta_{0i}$$
$$\beta_{1i}=\gamma_{10}+\eta_{1i}$$
-  $\gamma_{00}$ representa el promedio de recuperación para un individuo que al momento del traumatismo se encuentra en el umbral de riesgo (60 años), no reside en domicilio propio, el tratamiento recibido fue cirugía y al momento del ingreso su indice de Barthel fue de 30.

- $\gamma{10}$ es el efecto fijo promedio del tiempo `momento2` sobre la recuperación funcional al momento _primer mes_ tras lesión.

[Estimaciones:]{.underline}

-  $\gamma_{00}=0.66$ indica que, bajo las condiciones antes mencionadas, el promedio global de recuperación es de 0,66, es decir el 66%.

- $\gamma_{01}=-0.006$ indica que, para cada año por sobre la región critica de densidad osea (60 años), la recuperación global del individuo disminuye un 0,006.

- $\gamma_{02}=0.12$ indica que, si el individuo reside en domicilio propio, la recuperación global aumenta 0,12, tal como indica la literatura.

-  $\gamma{03}=0.17$ indica que, si el individuo se somete a tratamiento de fisioterapia en vez de cirugía, la recuperación global aumenta 0,17.

-  $\gamma_{04}=0.004$ indica que, por cada unidad aumentada sobre la moda de el indice de Barthel al ingreso (30), la recuperación aumenta un 0,004. Es decir, cuanto menos haya decaído tu calidad de vida, es mas fácil recuperarse.

-  Para $\eta_{0i}$, la varianza se estima en $0.0562246$, lo cual representa la variabilidad entre sujetos en el intercepto del modelo. Es decir, indica cuánto difieren entre sí los niveles iniciales de recuperación funcional (cuando todas las covariables están centradas) entre los diferentes individuos.

-  Para $\eta_{1i}$, la varianza se estima en $0.0002257$, lo que sugiere que la variabilidad entre sujetos en la pendiente asociada al tiempo `momento2` es extremadamente baja. En términos prácticos, esto implica que la evolución temporal de la recuperación funcional es muy similar entre individuos, y el modelo no detecta diferencias sustanciales en las tasas de cambio.

-  Para $\varepsilon_{it}$, la varianza se estima en $0.0946870$, lo cual representa la variabilidad individualmente no explicada por el modelo, es decir, las diferencias residuales en la recuperación de un mismo individuo a lo largo del tiempo, luego de controlar por los efectos fijos y aleatorios.

\newpage

## Predicción

```{r, echo=T}
mod_final = mod7
```

Se va a comparar los datos reales de 4 individuos y su predicción, destacando que hayan tenido una recuperación alta y baja y ambos tipos de tratamiento, intentando mantener la edad constante. Obviamente predecir con los datos que estamos entrenando tiene riesgos de overfitting, pero es para poder observar las formas de aproximar que tiene el modelo.

```{r, fig.cap='Trayectorias reales y predichas de 4 individuos.', fig.height=3}
newdata <- data %>% filter(id%in%c(260, 262, 291, 49))
newdata$recuperacion_pred <- predict(object=mod7, newdata=newdata)

ggplot(newdata)+
   geom_point(aes(x=momento2, y=recuperacion, color=factor(id)))+
   geom_point((aes(x=momento2, y=recuperacion_pred, color=factor(id))))+
   geom_line(aes(x=momento2, y=recuperacion, color=factor(id)))+
   geom_line(aes(x=momento2, y=recuperacion_pred, color=factor(id)), linetype = 'dashed')+
   theme_bw()+
   scale_color_viridis_d()
```

Los individuos 49 y 291 tienen 94 y 91 años respectivamente, siendo que el primero fue sometido a cirugía mientras que el segundo recibió tratamiento de fisioterapia. Se puede observar que sus trayectorias se cruzan, manteniéndose parecidas pero el 291 termina con una recuperación superior.

Los individuos 260 y 262 tienen 88 y 89 años respectivamente, siendo que el primero fue sometido a cirugía mientras que el segundo recibió tratamiento de fisioterapia. Las trayectorias predichas son casi idénticas, siendo nuevamente el que recibió fisioterapia (262) quien termina teniendo una recuperación levemente mayor.

# Conclusion

El modelo multinivel ajustado permitió captar adecuadamente la evolución de la recuperación funcional en adultos mayores tras una fractura de muñeca. A partir de una estructura jerárquica con intercepto y pendiente aleatoria por individuo, se identificaron efectos significativos de variables como la edad, el tratamiento recibido, el lugar de residencia y el nivel funcional al ingreso. Si bien persisten desafíos técnicos como la singularidad de la matriz de varianzas, los resultados obtenidos reflejan trayectorias coherentes con la literatura clínica y ofrecen una base sólida para futuras mejoras en el modelado.

\newpage

# Bibliografía
