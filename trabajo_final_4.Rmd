---
title: "Recuperación funcional"
subtitle: |
          | Proyecto final
          | Introducción a los Modelos Multinivel
author: 
  - 'Bajac, Matías'
  - 'Padín, Jimena'
  - 'Viscailuz, Luciana'
date: "2025"
output: bookdown::pdf_document2
bibliography: referencias.bib
nocite: '@*'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(readxl)
library(tidyverse)
library(rstatix)# para hacer ANOVA RM
library(GGally)
library(lme4)
library(lmerTest) #para incluir los p valores
library(kableExtra)
library(performance)
library(knitr)
```

```{r}
data <- read_xlsx('recuperacion_funcional.xlsx') %>% filter(id!=53)
```

\newpage

# Introducción

El estado físico y funcional del cuerpo humano desempeña un papel central en la calidad de vida de un individuo. A partir de cierta edad se producen cambios fisiológicos que afectan a varios sistemas de forma progresiva, entre ellos el musculo-esquelético. La disminución de la densidad osea incrementa la fragilidad en los huesos y favorece la aparición ante impactos relativamente leves. Este suceso se ve acelerado particularmente en mujeres tras la menopausia. Paralelamente, la pérdida de masa muscular, la reducción de reflejos y el deterioro del control motor y del equilibrio contribuyen a un mayor riesgo de caídas en adultos mayores.

En adultos mayores, lesiones de este índole afectan directamente su autonomía y capacidad para realizar actividades básicas de la vida diaria. La recuperación funcional posterior a estos eventos es un proceso complejo influido por factores individuales (edad, sexo), condiciones de vida y el tratamiento recibido, ya sea fisioterapia u opciones quirúrgicas.

Debido al componente dependiente de los datos, dado a que estos resultan ser múltiples mediciones de un mismo individuo, contar con herramientas que permitan evaluar la evolución funcional de los pacientes resulta fundamental. Medidas estandarizadas como el Índice de Barthel permiten cuantificar el nivel de independencia antes y después del traumatismo, y constituyen un insumo valioso para estudiar trayectorias de recuperación. Los modelos multinivel representan una estrategia estadística adecuada para analizar datos longitudinales, capturar variabilidad individual en los procesos de cambio y evaluar el efecto diferencial de los tratamientos, de acuerdo con los objetivos del estudio presentado en este informe.




# Datos

```{r, eval=F}
data$id %>% unique() %>% length()
```

Los datos fueron proporcionados por el docente a cargo de la unidad curricular. Se cuenta con información longitudinal de 327 adultos mayores que sufrieron un traumatismo de muñeca, producto de una caída. Para cada individuo se registran siete variables vinculadas a factores personales y el contexto temporal de la medición. Se excluyó un individuo que presentaba dos fracturas en años distintos sin información funcional previa suficiente para reconstruir una trayectoria longitudinal consistente.

## Variables estáticas

```{r, eval=F}
data$edad %>% summary()
```

```{r fig.height = 2.7, fig.width = 4, include=F}
data_id <- data %>% 
  distinct(id, .keep_all = TRUE)

ggplot(data_id, aes(x = edad)) +
  geom_histogram(bins = 15, fill = "#20A387FF", color = "black")+
   theme_bw()
ggsave('plots/edades.pdf')
```

```{=tex}
\begin{wrapfigure}{R}{4in}
  \includegraphics{plots/edades.pdf}
  \caption{Distribución de la edad en la muestra.}
  \vspace{-10pt}
\end{wrapfigure}
```

Diversos estudios han documentado que la densidad mineral ósea disminuye progresivamente con la edad. En particular, @zhang2010epidemiology señalan que la pérdida de densidad ósea se intensifica en la sexta década de vida, lo que incrementa el riesgo a fracturas. En nuestro conjunto de datos, los individuos presentan una edad media de 83.5 años, con un rango entre 65 y 101 años, valores claramente por encima de este umbral crítico. Por lo tanto, la edad adquiere un rol clínicamente relevante en el análisis de la recuperación funcional.

Si observamos la variabilidad de la muestra mediante un histograma, la mayoría de las personas que ingresaron al tratamiento tienen entre 80 y 90 años.

```{r, eval=F}
(data$sexo %>% table())/nrow(data)
```

En cuanto al género, la proporción de mujeres en la muestra es considerablemente mayor (80%), lo cual es consistente con la evidencia epidemiológica: tras la menopausia, la disminución abrupta de estrógenos acelera la pérdida de densidad mineral ósea, aumentando la fragilidad del sistema musculo-esquelético y, por ende, la probabilidad de sufrir fracturas por caída [@riggs1986involutional]. Por otro lado, la literatura también muestra diferencias significativas en la recuperación funcional según el género. @dimonaco2012men encuentra en su estudio que los hombres presentan peores resultados funcionales que las mujeres, por lo que resulta pertinente incluir el género como covariable a nivel individual en los modelos.

```{r, eval=F}
(data$tratamiento %>% table())/nrow(data)
```

Respecto al tratamiento recibido, la elección entre tratamiento quirúrgico y fisioterapia tras una fractura de muñeca depende tanto de las características de la lesión como de las características clínicas del paciente. En general, las fracturas estables mediante inmovilización seguida de fisioterapia, mientras que la cirugía se reserva para fracturas inestables. En nuestra muestra, el 37% de los pacientes recibió tratamiento conservador y el 63% tratamiento quirúrgico.

```{r, eval=F}
(data$domicilio %>% table())/nrow(data)
```

Finalmente, la condición habitacional constituye un factor relevante en la recuperación funcional de adultos mayores. Vivir en el propio domicilio suele asociarse a mayor autonomía y una rutina previa más estable, lo que favorece la readquisición de habilidades motoras y funcionales. Por el contrario, residir en un hogar o institución puede reflejar una situación de mayor dependencia previa o menor movilidad, elementos que tienden a enlentecer la recuperación tras una fractura. En nuestros datos, el 69% de los pacientes residía en su domicilio y el 31% en instituciones, por lo que esta variable se incorpora como covariable a nivel individual para capturar diferencias en el nivel funcional previo y en el apoyo disponible durante el proceso de rehabilitación.

## Variables temporales

```{r}
data <- data %>% 
   mutate(momento = factor(momento,
                           levels=c('previo', 'ingreso', 
                                   '1 mes', '3 meses', 
                                   '12 meses', '24 meses')))
```

La variable que determina el tiempo donde se releva la información y le que otorga estructura longitudinal al conjunto de datos, `momentos`, establece tiempos de medición previos a la lesión, al momento de ingreso al sistema hospitalario y posteriormente a los 1, 3, 12 y 24 meses del evento, siendo las dos primeras mediciones disponibles para todos los individuos, mientras que las siguientes se registran de forma más esporádica.

```{r}
data$momento %>% table() %>% t() %>%  kable() %>%
   kable_styling(latex_options = 'HOLD_position')
```

Para estos momentos se releva la variable `barthel`. Como se establece por @mahoney1965barthel, el índice de Barthel es un índice simple de independencia para evaluar la capacidad de un paciente con un trastorno neuro-muscular o musculo-esquelético para cuidar de sí mismo. Los valores asignados a cada ítem se basan en el tiempo y la cantidad de asistencia física real requerida si un paciente no puede realizar la actividad.

```{r plot1, warning=F, fig.cap = 'Boxplot del índice de Barthel para diferentes momentos en relación a la lesión.', fig.height=2.5, fig.width=5}
data %>% ggplot()+
   geom_boxplot(aes(x=momento, y=barthel, fill=momento))+
   theme(legend.position = 'none')+
   theme_bw()+scale_fill_viridis_d()
```

En la Figura \@ref(fig:plot1) se muestra la distribución del Índice de Barthel en cada uno de los momentos de medición, con el objetivo de obtener una primera impresión de la evolución funcional de los pacientes. Se observa que, antes de la lesión, los individuos presentan niveles elevados de independencia funcional, en general por encima de 75 puntos. Tras el ingreso hospitalario, el puntaje disminuye de forma marcada, reflejando el estado físico asociado al evento. A partir del primer mes, los valores comienzan a incrementarse nuevamente, acompañando el proceso de recuperación. Entre el mes y dos años del incidente, la varianza del estado físico de los pacientes aumenta bastante, en comparación con los dos momentos del tiempo anteriores.

```{r}
b_prev <- data %>% filter(momento=='previo') %>% 
   mutate(b_prev = barthel) %>% select(id,b_prev) %>% unique()
b_ing <- data %>% filter(momento=='ingreso') %>% 
   mutate(b_ing = barthel) %>% select(id,b_ing) %>% unique()
data <- data %>% left_join(b_prev, by='id')%>% left_join(b_ing, by='id')
```

Por ultimo, la variable `recuperacion`, definida como $recuperacion = \frac{barthel_{actual}-barthel_{ingreso}}{barthel_{previo}-barthel_{ingreso}}$, se encuentra disponible para todos los momentos de medición excepto para el momento previo a la lesión dado que la expresión carece de interpretación clínica. Dado a su composición la misma se encuentra altamente relacionada con `barthel`:

```{r, warning=F}
data |>filter(momento!='previo') %>% 
  group_by(momento) |>
  summarise(r_barthel = cor(barthel,recuperacion,use = "complete.obs")) %>% t() %>% kable() %>% kable_styling(latex_options = 'HOLD_position')
```

A continuación, se presenta un segundo gráfico con la evolución en el tiempo de diez de los pacientes. Se identifica que todos comparten el mismo punto inicial, donde la tasa de recuperación al ingreso en el hospital vale 0. Esto tiene sentido ya que es el momento en el que sufrieron el traumatismo, previo a comenzar el tratamiento.

Se puede observar que las pendientes de las trayectorias difieren, y que, además, hay algunas más largas que otras, indicando que hay pacientes a los que no se les realizó un seguimiento continuo en el tiempo o que abandonaron el tratamiento.

```{r,fig.height=3.5, fig.cap='Trayectorias individuales de recuperación funcional para una muestra de pacientes seleccionados.'}
data %>% filter(id%in%c(1:10), momento!='previo') %>% ggplot()+
   geom_line(aes(x=momento, y=recuperacion, group = factor(id),
                 color=factor(id)))+
   geom_point(aes(x=momento, y=recuperacion, group = factor(id),
                 color=factor(id)))+
   labs(color='id')+
   theme_bw()+
   scale_color_viridis_d()
```

\newpage
 
# Metodología

Al trabajar con medidas repetidas, hay varios modelos posibles, entre ellos el RM – ANOVA, el cual es una adaptación del modelo ANOVA para medidas repetidas. Este no es el que se utilizó para el presente análisis, ya que supone que los datos deben estar balanceados, y como se mencionó anteriormente, en los datos disponibles esto no sucede.

Otro modelo posible, y con el que se decidió trabajar es el Modelo de Efectos Mixtos (LME), debido a que es mucho más flexible con respecto a los supuestos y presenta varias ventajas con respecto al modelo anterior.

Dado al tipo de datos, se identifica a los individuos y sus variables como el nivel 2 ($i$), mientras que las observaciones para cada individuo son de nivel 1 ($t$).

## Descripción de las variables 

Para la creación de modelos se establece como variable dependiente la recuperación del paciente, `recuperacion`. Previo a crear los modelos, se realizaron algunos ajustes sobre los datos:

-   Dado que al utilizar `recuperacion` como variable dependiente las observaciones de momento previo carecen de interpretación, las mismas fueron excluidas del análisis longitudinal. En su lugar se agrega una variable `b_prev` que indica el valor de índice de Barthel previo a la lesión.

```{r}
# ya se hizo antes, en datos sobre momentos para verificar como se creaba recuperacion
data <- data %>% filter(momento!='previo')
```

-   Dado que `recuperacion` se establece en 0 al momento del ingreso, mantener dicho momento produciria una constante sin interpretacion sustantiva y dificultaria la interpretacion de la variabilidad entre sujetos. Se decide excluir dichas observaciones y, en cambio, agregar una variable `b_ing` que indica el valor de índice de Barthel al momento del ingreso.

```{r}
# ya se hizo antes, en datos sobre momentos para verificar como se creaba recuperacion
data <- data %>% filter(momento!='ingreso')
```

-   Considerando los cambios previos, la primera observacion longitudinal se define en el momento _1 mes_. Si se define este como momento 0, permite una mejor interpretacion de las constantes. Es por ello que la variable `momento2`, tomando en cuenta los meses transcurridos, se codifica {0, 2, 11, 23} para los momentos 1 mes, 3 meses, 12 meses y 24 meses, respectivamente.

```{r}
data = data %>%  
   mutate(momento2 = case_when(momento == "1 mes" ~ 0,
                              momento == "3 meses" ~ 2,
                              momento == "12 meses" ~ 11,
                              momento == "24 meses" ~ 23,
                              TRUE ~ NA_real_))
```

-   Respecto a la edad, siguiendo la literatura que indica el umbral critico referente a la densidad osea, se decide centrar la variable respecto a 60, con el fin que la interpretación de la constante refiera a la recuperación promedio en el umbral, y varíe para cada año por sobre el mismo ($edad2 = edad-60$).

```{r}
data <- data %>% 
   mutate(edad2 = edad - 60,
          tratamiento = as.factor(tratamiento),
          domicilio = as.factor(domicilio),
          sexo = as.factor(sexo),
          id = as.factor(id))
```

Por lo que las variables a seleccionar para ajustar el modelo son:

```{=tex}
\begin{table}[h]
\begin{tabular}{llll}
\hline
\textbf{Variable} & \textbf{Descripción} & \textbf{Valores} & \textbf{Nivel}\\ 
\hline

recuperacion & Variable dependiente & Continua, rango[-0.67,1.60] & nivel 1\\

tratamiento & Variable categórica que indica el típo de & cirugía o fisioterapia & nivel 2\\
&tratamiento que es sometido el paciente luego de &&\\
&la lesión &&\\

domicilio & Variable dummy que indica si el individuo hizo & si o no & nivel 2\\
& la recuperacion en su domicilio o en una institución & &\\

sexo & Varibale que indica el sexo del individuo & M o F & nivel 2\\

momento2 & Variable que toma como referencia el primer & 0, 2, 11, 23 & nivel 1\\
& mes luego del ingreso, metrica temporal & &\\

edad2 & Variable de edad de los individuos a la hora & rango[5,41] & nivel 2\\
& del ingreso, centrada en 60 años & & \\

b\_prev & Indice de Barthel previo a la lesion & rango[0,100] & nivel 2\\

b\_ing & Indice de Barthel al momento del ingreso & rango[0,100] & nivel 2\\

\hline
\end{tabular}
\caption{Variables a utilizar en los modelos.}
\label{tab:variables}
\end{table}
```




Nota: Se decidió no incorporar la variable Barthel al modelo debido a que como se mencionó anteriormente, esta se utiliza para construir la variable dependiente, por lo que el incluirla en el modelo llevaría a que absorba el efecto de las demás variables y se generen interpretaciones erróneas.



## Modelado

Se comienza por discernir la estructura apropiada de la matriz $\pmb D$. Bajo la hipótesis nula, se asume que ningún efecto aleatorio $k$ tiene un aporte significativo al modelo (modelo lineal):

\begin{equation}
H_0) \; \pmb D_i = 
\begin{bmatrix}
\pmb D_{q\times q} & \pmb 0_{q\times k}\\
\pmb 0_{k\times q} & \pmb 0_{k\times k}
\end{bmatrix}
\end{equation}

A partir de los modelos ajustados con `lmer(REML = FALSE)`, la significación de los componentes de varianza se evalúa empleando la mezcla de distribuciones propuesta por @Stram1994.

Una vez establecida la estructura de $\pmb D$, se crearon diversos modelos LME utilizando la función `lmer(`) del paquete `lme4`, además se aplicó la corrección de los grados de libertad de Kenward-Roger, la cual presenta ventajas sobre la corrección Satterthwait especialmente en muestras pequeñas y datos desbalanceados.

\newpage

# Resultados

## Estructura de la matriz $\pmb D$

```{r, echo=T, warning=F}
mod0 <- lm(recuperacion ~ 1, data=data)
mod1 <- lmer(recuperacion ~ 1 + (1|id), data=data, REML=F)
mod2 <- lmer(recuperacion ~ 1 + (momento2|id), data=data, REML=F)
```

```{r, echo=T}
L0 <- logLik(mod0)
L1 <- logLik(mod1)
LRT <- -2*(L0 - L1)
0.5*pchisq(LRT, 1, lower.tail = FALSE)
```

El p-valor obtenido para evaluar la inclusión de contantes aleatorias indica que dichos efectos son estadísticamente significativos.

```{r, echo=T}
L2 <- logLik(mod2)
LRT <- -2*(L1 - L2)
pchisq(LRT,c(1,2),lower.tail = FALSE) |> mean()
```
Dado el resultado del test se adopta como estructura aleatoria final un modelo con constantes y pendientes aleatorias. El modelo jerárquico resultante es:

$$recuperacion_{it} = \beta_{0i} + \beta_{1i}momento2_{it} + \varepsilon_{it} \qquad i=1,2,...,327\quad t=0,2,11,23$$
$$\beta_{0i}=\gamma_{00}+\eta_{0i}$$
$$\beta_{1i}=\gamma_{10}+\eta_{1i}$$

```{r, echo=T}
# Modelo Base
mod0 <- lmer(recuperacion ~ momento2 + (momento2|id), data=data)
summary(mod0, ddf = "Kenward-Roger")
```

_COMENTARIO O SACO EL SUMMARY?_

## Inclusión de covariables al modelo

Se comienza un modelo base, donde hay un intercepto y pendiente aleatoria para cada paciente. Luego, se incorporan como efectos fijos otras variables como la edad al momento del traumatismo, el sexo y domicilio del paciente, que como se mencionó anteriormente, la literatura las identifica como variables relevantes.

```{r, echo=T}
mod1 = lmer(recuperacion ~ sexo + edad2 + domicilio + (momento2|id), data= data)
anova(mod0,mod1) # se acepta el modelo nuevo
summary(mod1, ddf = "Kenward-Roger")
```

Del modelo anterior, se detecta que en contradicción con lo que la literatura señalaba, el genero del paciente no es significativo para explicar la recuperación del mismo, por lo que se decide prescindir de esta variable.

Además, se decide incluir la variable tratamiento como efecto fijo. al incorporarla de esta forma se puede contrastar el objetivo planteado, identificar el efecto del tratamiento sobre la recuperación en si mismo, es decir, detectar si la evolución en la recuperación de los pacientes varía según el tratamiento proporcionado.

```{r, echo=T}
mod2= lmer(recuperacion ~ edad2 + domicilio + tratamiento + (momento2|id),data= data) #sacamos sexo y agregamos tratamineto, comparamos con mod0
anova(mod0,mod2) #aceptamos el nuevo modelo
summary(mod2, ddf = "Kenward-Roger")
```

_todo relevante_

*probamos b_prev*

```{r,eval=F, echo=T}
mod3= lmer(recuperacion ~ edad2 + domicilio + tratamiento + b_prev + (momento2|id), data= data)
anova(mod2,mod3) # no da nada
```
La variable no es lo suficientemente significativa por si misma para ser incluida en el modelo.

*probamos b_ing*

```{r,eval=F, echo=T}
mod4= lmer(recuperacion ~ edad2 + domicilio + tratamiento + b_ing + (momento2|id),data= data)
anova(mod2,mod4) # da algo
summary(mod4, ddf = "Kenward-Roger")
```

La variable de significativa al 95% pero no al 99%, a la vez que empeora la significación de la edad. ver si alguna interacción aumenta la potencia.

*probamos b_ing x b_prev*

```{r,eval=F, echo=T, warning=F}
mod5= lmer(recuperacion ~ edad2 + domicilio + tratamiento + b_ing*b_prev + (momento2|id),data= data)
anova(mod2,mod5) #no da nada
```

no da nada

*probamos b_ing x momento2*

```{r,eval=F, echo=T}
mod6= lmer(recuperacion ~ edad2 + domicilio + tratamiento + b_ing*momento2 + (momento2|id),data= data)
anova(mod2,mod6) # da casi al 99%, no se si dejarlo o no
summary(mod6)
```

_voy a no dejar b_ing o la interaccion con momento ahora, pero decidir y agregar. yo creo que puede estar bueno, sobre tood como interaccion la significacion aumenta y me parece que el barchel ingreso puede ser mas relevante en primeras etapas de recuperacion que en ultimas_

_me acaba de entrar la duda de que momento2 tambien tiene que estar como efecto fijo? porque si la ponemos en el mod0 no da significativa como fijo. capaz que eso evaluar como primer modelo para explicar porque no aparece ahi y solo en pendientes_

_tambien me falto la interaccion tratamiento*momento2_

Como la pregunta que se buscaba responder es si el tratamiento tiene efectos sobre la evolución de la recuperación, además de incluir el efecto fijo del tratamiento, se decidió incorporar la interacción entre momento y tratamiento, de la cual también se desprende que su efecto no es significativo sobre la variable dependiente.

```{r,eval=F, echo=T}
mod5= lmer(recuperacion ~ edad2 + domicilio + tratamiento + momento2*tratamiento + (0+momento2|id),data= data)
summary(mod5, ddf = "Kenward-Roger")
```

_comentario, no da nada_

## Modelo final

$$escribirlo$$

```{r, eval=F, echo=T}
mod_final = 
summary(mod_final)
```

_insterpretar_

## Predicción

_capaz que esto lo reescribo para compararlo con trayectorias reales buenas y malas_

```{r, eval=F, echo=T}
newdata <- 
   data.frame(
      id=c(rep(328,4),rep(329,4)),
      sexo=c('M','M','M','M', 'F', 'F', 'F', 'F'),
      edad2=c(rep(85-60, 8)),
      tratamiento = c(rep('cirugía',4), rep('fisioterapia',4)),
      domicilio=c(rep('si',8)),
      momento2=c(0,2,11,23,0,2,11,23),
      b_ini=c(rep(30,8)))

newdata$recuperacion <- predict(object=mod2, newdata=newdata)

ggplot(newdata, aes(x=momento2, recuperacion, group = factor(tratamiento),color=factor(tratamiento)))+
   geom_point()+
   geom_line()

data %>% filter(momento=='ingreso') %>%  ggplot()+geom_histogram(aes(x=as.numeric(barthel)))
data %>% group_by(momento) %>% 
   summarise(r_min=min(recuperacion,na.rm = T),
             r_media=mean(recuperacion,na.rm = T),
             r_max=max(recuperacion,na.rm = T),)
```








Se llegó a un modelo final, el cual permite cumplir con los objetivos planteados, sin embargo, se abre espacio a mejorar el presentado modelo, debido a que problemas como el de la matriz singular persisten.

\newpage

# Bibliografía
