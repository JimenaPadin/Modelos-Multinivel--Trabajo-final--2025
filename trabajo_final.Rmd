---
title: "Recuperación funcional"
subtitle: |
          | Proyecto final
          | Introducción a los Modelos Multinivel
author: 
  - 'Bajac, Matías'
  - 'Padín, Jimena'
  - 'Viscailuz, Luciana'
date: "2025"
output: pdf_document
bibliography: referencias.bib
nocite: '@*'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(readxl)
library(tidyverse)
library(rstatix)# para hacer ANOVA RM
library(GGally)
library(lme4)
library(lmerTest) #para incluir los p valores
library(kableExtra)
```

```{r}
data <- read_xlsx('recuperacion_funcional.xlsx') %>% filter(id!=53)
```

# Introducción

El estado físico y funcional del cuerpo humano desempeña un papel central en la calidad de vida de un individuo. A partir de cierta edad se producen cambios fisiológicos que afectan a varios sistemas de forma progresiva, entre ellos el musculo-esquelético. La disminución de la densidad osea incrementa la fragilidad en los huesos y favorece la aparición ante impactos relativamente leves. Este suceso se ve acelerado particularmente en mujeres tras la menopausia. Paralelamente, la pérdida de masa muscular, la reducción de reflejos y el deterioro del control motor y del equilibrio contribuyen a un mayor riesgo de caídas en adultos mayores.

En adultos mayores, lesiones de este índole afectan directamente su autonomía y capacidad para realizar actividades básicas de la vida diaria. La recuperación funcional posterior a estos eventos es un proceso complejo influido por factores individuales (edad, sexo), condiciones de vida y el tratamiento recibido, ya sea fisioterapia u opciones quirúrgicas.

Debido al componente dependiente de los datos, dado a que estos resultan ser múltiples mediciones de un mismo individuo, contar con herramientas que permitan evaluar la evolución funcional de los pacientes resulta fundamental. Medidas estandarizadas como el Índice de Barthel permiten cuantificar el nivel de independencia antes y después del traumatismo, y constituyen un insumo valioso para estudiar trayectorias de recuperación. Los modelos multinivel representan una estrategia estadística adecuada para analizar datos longitudinales, capturar variabilidad individual en los procesos de cambio y evaluar el efecto diferencial de los tratamientos, de acuerdo con los objetivos del estudio presentado en este informe.

# Datos

```{r, eval=F}
data$id %>% unique() %>% length()
```

Los datos fueron proporcionados por el docente a cargo de la unidad curricular. Se cuenta con información longitudinal de 327 adultos mayores que sufrieron un traumatismo de muñeca, producto de una caída. Para cada individuo se registran siete variables vinculadas a factores personales y el contexto temporal de la medición. Se excluyó un individuo que presentaba dos fracturas en años distintos sin información funcional previa suficiente para reconstruir una trayectoria longitudinal consistente.

## Variables estáticas

```{r, eval=F}
data$edad %>% summary()
```

Diversos estudios han documentado que la densidad mineral ósea disminuye progresivamente con la edad. En particular, @zhang2010epidemiology señalan que la pérdida de densidad ósea se intensifica en la sexta década de vida, lo que incrementa el riesgo a fracturas. En nuestro conjunto de datos, los individuos presentan una edad media de 83.5 años, con un rango entre 65 y 101 años, valores claramente por encima de este umbral crítico. Por lo tanto, la edad adquiere un rol clínicamente relevante en el análisis de la recuperación funcional.

```{r, eval=F}
(data$sexo %>% table())/nrow(data)
```

En cuanto al género, la proporción de mujeres en la muestra es considerablemente mayor (80%), lo cual es consistente con la evidencia epidemiológica: tras la menopausia, la disminución abrupta de estrógenos acelera la pérdida de densidad mineral ósea, aumentando la fragilidad del sistema musculo-esquelético y, por ende, la probabilidad de sufrir fracturas por caída [@riggs1986involutional]. Por otro lado, la literatura también muestra diferencias significativas en la recuperación funcional según el género. @dimonaco2012men encuentra en su estudio que los hombres presentan peores resultados funcionales que las mujeres, por lo que resulta pertinente incluir el género como covariable a nivel individual en los modelos.

```{r, eval=F}
(data$tratamiento %>% table())/nrow(data)
```

Respecto al tratamiento recibido, la elección entre tratamiento quirúrgico y fisioterapia tras una fractura de muñeca depende tanto de las características de la lesión como de las características clínicas del paciente. En general, las fracturas estables mediante inmovilización seguida de fisioterapia, mientras que la cirugía se reserva para fracturas inestables. En nuestra muestra, el 37% de los pacientes recibió tratamiento conservador y el 63% tratamiento quirúrgico.

```{r, eval=F}
(data$domicilio %>% table())/nrow(data)
```

Finalmente, la condición habitacional constituye un factor relevante en la recuperación funcional de adultos mayores. Vivir en el propio domicilio suele asociarse a mayor autonomía y una rutina previa más estable, lo que favorece la readquisición de habilidades motoras y funcionales. Por el contrario, residir en un hogar o institución puede reflejar una situación de mayor dependencia previa o menor movilidad, elementos que tienden a enlentecer la recuperación tras una fractura. En nuestros datos, el 69% de los pacientes residía en su domicilio y el 31% en instituciones, por lo que esta variable se incorpora como covariable a nivel individual para capturar diferencias en el nivel funcional previo y en el apoyo disponible durante el proceso de rehabilitación.

## Variables temporales

```{r}
data <- data %>% 
   mutate(momento = factor(momento,
                           levels=c('previo', 'ingreso', 
                                   '1 mes', '3 meses', 
                                   '12 meses', '24 meses')))
```

La variable que determina el tiempo donde se releva la información y le que otorga estructura longitudinal al conjunto de datos, `momentos`, establece tiempos de medición previos a la lesión, al momento de ingreso al sistema hospitalario y posteriormente a los 1, 3, 12 y 24 meses del evento, siendo las dos primeras mediciones disponibles para todos los individuos, mientras que las siguientes se registran de forma más esporádica.

```{r}
data$momento %>% table() %>% t() %>%  kable() %>%
   kable_styling(latex_options = 'HOLD_position')
```

Para estos momentos se releva la variable `barthel`.

Como se establece por @mahoney1965barthel, el índice de Barthel es un índice simple de independencia para evaluar la capacidad de un paciente con un trastorno neuro-muscular o musculo-esquelético para cuidar de sí mismo. Los valores asignados a cada ítem se basan en el tiempo y la cantidad de asistencia física real requerida si un paciente no puede realizar la actividad.

```{r plot1, warning=F, caption = 'Boxplot del índice de Barthel para diferentes momentos en relación a la lesión.'}
data %>% ggplot()+
   geom_boxplot(aes(x=momento, y=barthel, fill=momento))+
   theme(legend.position = 'none')+
   theme_bw()+scale_fill_viridis_d()
```

En la Figura @ref{plot1} se muestra la distribución del Índice de Barthel en cada uno de los momentos de medición, con el objetivo de obtener una primera impresión de la evolución funcional de los pacientes. Se observa que, antes de la lesión, los individuos presentan niveles elevados de independencia funcional, en general por encima de 75 puntos. Tras el ingreso hospitalario, el puntaje disminuye de forma marcada, reflejando el estado físico asociado al evento. A partir del primer mes, los valores comienzan a incrementarse nuevamente, acompañando el proceso de recuperación. Entre el mes y dos años del incidente, la varianza del estado físico de los pacientes aumenta bastante, en comparación con los dos momentos del tiempo anteriores.

```{r}
b_prev <- data %>% filter(momento=='previo') %>% 
   mutate(b_prev = barthel) %>% select(id,b_prev) %>% unique()
b_ini <- data %>% filter(momento=='ingreso') %>% 
   mutate(b_ini = barthel) %>% select(id,b_ini) %>% unique()
data <- data %>% left_join(b_prev, by='id')%>% left_join(b_ini, by='id')
```

Por ultimo, la variable `recuperacion`, definida como $recuperacion = \frac{barthel_{actual}-barthel_{ingreso}}{barthel_{previo}-barthel_{ingreso}}$, se encuentra disponible para todos los momentos de medición excepto para el momento previo a la lesión dado que la expresión carece de interpretación clínica.

```{r, caption='Trayectorias individuales de recuperación funcional para una muestra de pacientes seleccionados.'}
data %>% filter(id%in%c(1:10), momento!='previo') %>% ggplot()+
   geom_line(aes(x=momento, y=recuperacion, group = factor(id),
                 color=factor(id)))+
   labs(color='id')+
   theme_bw()+
   scale_color_viridis_d()
```

# Metodología

Al trabajar con medidas repetidas, hay varios modelos posibles, entre ellos el RM – ANOVA, el cual es una adaptación del modelo ANOVA para medidas repetidas. Este no es el que se utilizó para el presente análisis, ya que supone que los datos deben estar balanceados, y como se mencionó anteriormente, en los datos disponibles esto no sucede.

Otro modelo posible, y con el que se decidió trabajar es el Modelo de Efectos Mixtos (LME), debido a que es mucho más flexible con respecto a los supuestos y presenta varias ventajas con respecto al modelo anterior.

Para la creación de modelos se establece como variable dependiente la recuperación del paciente, `recuperacion`. Previo a crear los modelos, se realizaron algunos ajustes sobre los datos:

-   Dado que al utilizar `recuperacion` como variable dependiente las observaciones de momento previo carecen de interpretacion, las mismas fueron excluidas del análisis longitudinal. En su lugar se agrega una variable `b_prev` que indica el valor de índice de Barthel previo a la lesión.

```{r}
# ya se hizo antes, en datos sobre momentos para verificar como se creaba recuperacion
data <- data %>% filter(momento!='previo')
```

-   En consecuencia a lo anterior, definir el instante ingreso como momento 0 produciría una constante sin interpretación sustantiva y dificultaría la interpretación de la variabilidad entre sujetos. Es por ello que la variable `momentos2` toma de referncia el primer mes posterior al ingreso y se codifica {-1, 0, 2, 11, 23} para los momentos de ingreso, 1 mes, 3 meses, 12 meses y 24 meses, respectivamente.

```{r}
data = data %>%  
   mutate(momento2 = case_when(momento == "ingreso" ~ -1,
                              momento == "1 mes" ~ 0,
                              momento == "3 meses" ~ 2,
                              momento == "12 meses" ~ 11,
                              momento == "24 meses" ~ 23,
                              TRUE ~ NA_real_))
```

-   Respecto a la edad, siguiendo la literatura que indica el umbral critico referente a la densidad osea, se decide centrar la variable respecto a 60, con el fin que la interpretación de la constante refiera a la recuperación promedio en el umbral, y varíe para cada año por sobre el mismo ($edad2 = edad-60$).

```{r}
data <- data %>% 
   mutate(edad2 = edad - 60,
          tratamiento = as.factor(tratamiento),
          domicilio = as.factor(domicilio),
          sexo = as.factor(sexo),
          id = as.factor(id))
```

Se procede a plantear el modelo 0 y definir la estructura de la matriz D, donde se utiliza `anova` para evaluar la significación de las constantes y pendientes aleatorias.

Después se establecen diferentes modelos...

# Resultados

## Posibles modelos

Se crearon diversos modelos LME utilizando la función lmer() del paquete lme4, además se aplicó la corrección de los grados de libertad de Kenward - Roger, la cual presenta ventajas sobre la corrección Satterthwait especialmente en muestras pequeñas y datos desbalanceados.

``` {reval="F," echo="T"}


## empezamos con el modelo mas basico y le vamos agregando variables hasta llegar al modelo completo  
mod0 = lm(barthel ~ 1 ,data = data ) ## modelo lineal 
## modelo con efecto aleatorio en la cte 

#al condicionar por id, se trabaja con que la unidad es el nivel 2 y las mediciones nivel 1, es decir, tenemos tantos grupos com individuos
mod1 = lmer(barthel ~  edad  + (1|id), data = data , REML = FALSE) 

library(lmerTest)
#usando como recuperacion como variable dependiente
mod2 = lmer(recuperacion ~ tratamiento + edad + (momento|id),data= data) ## incluyo  efectos aleatorios,  en la constante y el la pendiente
summary(mod2, ddf = "Kenward-Roger")



mod3 = lmer(recuperacion ~ barthel*momento  + edad +  (momento|id),data= data) # interseccion barthel con momento 
summary(mod3, ddf = "Kenward-Roger")


#al incluir la interacción entre barthel y momento, la variable tratamiento deja de ser significativa
 mod4 = lmer(recuperacion ~ barthel*momento  +  tratamiento + edad  + (momento|id),data=data) ## boundary !!

summary(mod4, ddf = "Kenward-Roger")




L0 <- logLik(mod0)
L1 = logLik(mod1)
L2= logLik(mod2)
L3 = logLik(mod3)

LRT <- -2*(L0 - L1)
LRT2  = -2*(L1-L2)
LRT3  = -2*(L2-L3)

alfa <- 0.05
anova(mod0,mod1)
anova(mod2, mod1)


qchisq(1 - 2*alfa, 1)
# p-valor
0.5*pchisq(LRT, 1, lower.tail = FALSE)
## agregar un efecto  aleatorio tiene un aporte significativo 

pchisq(LRT,c(1,2),lower.tail = FALSE) %>%  mean()

anova(mod1,mod2)
anova(mod2,mod3)


#otros modelo

mod5 = lmer(recuperacion ~ tratamiento*momento  +  barthel + edad + sexo + (momento |id),data=data) 
summary(mod5, ddf = "Kenward-Roger")
#el sexo no me da significativo

mod6 = lmer(recuperacion ~ tratamiento*momento  +  barthel + edad + (momento |id),data=data) 
summary(mod6, ddf = "Kenward-Roger")
#el tratamiento no explica nada

#si se saca barthel tratamiento pasa a ser significativo
mod6 = lmer(recuperacion ~ tratamiento*momento + edad + (momento |id),data=data) 
summary(mod6, ddf = "Kenward-Roger")

data
```

*nuevo*

Modelo 0: *esto deberia ir en metodologia* $$recuperacion_{ij} = \beta_{0i} + \beta_{1i}t_{ij} + \varepsilon_{ij}$$ $$\beta_{0i}=\gamma_{00}+\eta_{0i}$$ $$\beta_{1i}=\gamma_{10}$$ *si aca se agrega la variable aleatoria eta queda con pendientes aleatorias dependientes de momentos*

```{r}
mod0 <- lmer(recuperacion~ momento2 + (1|id), data = data)
summary(mod0)

mod1 <- lmer(recuperacion~ momento2 + (momento2|id), data = data)

anova(mod0,mod1)
```

\newpage

Modelo Base

Se comienza un modelo base, donde hay un intercepto fijo y cada paciente tiene su propio intercepto y pendiente, dada por los diferentes momentos. Luego, se incorporan como efectos fijos otras variables como la edad al momento del traumatismo, el sexo y domicilio del paciente, que como se mencionó anteriormente, la literatura las identifica como variables relevantes.

Estos modelos presentan un incoveniente, la matriz es singular, sin embargo, al analizar la matriz D, la varianza no es 0, aunque si muy baja. De igual forma se decide mantener este modelo como base tomando en cuenta las precauciones necesarias.

```{r}
#edad y sexo efectos fijos porque no cambian dentro del mismo id
mod0 = lmer(recuperacion ~ 1 + (momento2|id), data= data)
summary(mod0, ddf = "Kenward-Roger")
mod0 = lmer(recuperacion ~ sexo + edad2 + domicilio + (momento2|id), data= data)
summary(mod0, ddf = "Kenward-Roger")
```

Del modelo anterior, se detecta que en contradicción con lo que la literatura señalaba, el genero del paciente no es significativo para explicar la recuperación del mismo, por lo que se decide prescindir de esta variable.

Además, se incluye la variable tratamiento como efecto fijo, se decide incorporarla de esta forma y no como efecto aleatorio debido al objetivo que se planteó, se quiere identificar el efecto del tratamiento sobre la recuperación en si mismo, es decir, detectar si la evolución en la recuperación de los pacientes varía segun el tratamiento proporcionado.

```{r}
mod1= lmer(recuperacion ~ edad2 + tratamiento + (momento2|id),data= data)
summary(mod1, ddf = "Kenward-Roger")
```

En un principio, pareciera que el tratamiento si presenta un efecto sobre la recuperación, sin embargo, al crear un nuevo modelo incorporando la variable barthel las interpretaciones se ven afectadas.

```{r}
mod2= lmer(recuperacion ~ barthel + edad +  tratamiento+ (momento|id),data= data)
summary(mod2, ddf = "Kenward-Roger")
```

Al incluir el Índice del estado funcional de los individuos como efecto fijo, parte del efecto que anteriormente se le asignaba al tratamiento pasa a ser explicado por la nueva variable. Lo que sucede es una confusión, debido a que barthel y tratamiento se encuentran correlacionadas entre sí.

Se detecta que dependiendo el valor de barthel del paciente, el tratamiento que se le asigna, mientras que a los pacientes que se encuentran con un valor del índice más elevados o no presentan grandes variaciones en este, (entre antes y después del traumatismo), se los trata con fisioterapia, a los pacientes que si presentan grandes daños producto del incidente se les realiza cirugia.

Por lo mencionado, en un anterior modelo se observaba que la recuperación cambiaba entre tratamientos, sin embargo, esto se debía a que al ingresar al hospital, dependiendo del estado funcional del paciente, el tratamiento que se le asignaba. El nuevo modelo es capaz de diferenciar que proporción de la recuperación se debe al nivel funcional y cuál al tratamiento.

Como la pregunta que se buscaba responder es si el tratamiento tiene efectos sobre la evolución de la recuperación, además de incluir el efecto fijo del tratamiento, se decidió incorporar la interacción entre momento y tratamiento, de la cual también se desprende que su efecto no es significativo sobre la variable dependiente.

```{r}
mod3 <- lmer(recuperacion ~ barthel + momento + tratamiento +
                            momento:tratamiento +
                            edad + (momento | id),
             data = data)
summary(mod3, ddf = "Kenward-Roger")
```

Se permite intepretar que la evolución de la recuperación de los pacientes no cambia segun el tratamiento, sin embargo, si se incorpora como efecto fijo la interacción entre barthel y momentos se puede identificar que el índice si influye en la evolución de la variable de interés.

```{r}
#peeero:

#MODELO FINAL)?
mod4= lmer(recuperacion ~ barthel*momento  + edad + (momento|id),data= data)
summary(mod4, ddf = "Kenward-Roger")

#si se detecta que la relación entre el barthel y la recuperación cambia con el tiempo


#PROBLEMA: HAY MUCHOS BOUNDARY, NO SE VAN CON NADA :(
```

Se llegó a un modelo final, el cual permite cumplir con los objetivos planteados, sin embargo, se abre espacio a mejorar el presentado modelo, debido a que problemas como el de la matriz singular persisten.

# Bibliografía
