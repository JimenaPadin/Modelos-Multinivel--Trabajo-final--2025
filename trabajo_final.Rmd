---
title: "Recuperación funcional"
subtitle: |
          | Proyecto final
          | Introducción a los Modelos Multinivel
author: 
  - 'Bajac, Matías'
  - 'Padín, Jimena'
  - 'Viscailuz, Luciana'
date: "2025"
output: pdf_document
bibliography: referencias.bib
nocite: '@*'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(readxl)
library(tidyverse)
library(rstatix)# para hacer ANOVA RM
library(GGally)
library(lme4)
library(lmerTest) #para incluir los p valores
library(kableExtra)
library(performance)
```

```{r}
data <- read_xlsx('recuperacion_funcional.xlsx') %>% filter(id!=53)
```

# Introducción

El estado físico y funcional del cuerpo humano desempeña un papel central en la calidad de vida de un individuo. A partir de cierta edad se producen cambios fisiológicos que afectan a varios sistemas de forma progresiva, entre ellos el musculo-esquelético. La disminución de la densidad osea incrementa la fragilidad en los huesos y favorece la aparición ante impactos relativamente leves. Este suceso se ve acelerado particularmente en mujeres tras la menopausia. Paralelamente, la pérdida de masa muscular, la reducción de reflejos y el deterioro del control motor y del equilibrio contribuyen a un mayor riesgo de caídas en adultos mayores.

En adultos mayores, lesiones de este índole afectan directamente su autonomía y capacidad para realizar actividades básicas de la vida diaria. La recuperación funcional posterior a estos eventos es un proceso complejo influido por factores individuales (edad, sexo), condiciones de vida y el tratamiento recibido, ya sea fisioterapia u opciones quirúrgicas.

Debido al componente dependiente de los datos, dado a que estos resultan ser múltiples mediciones de un mismo individuo, contar con herramientas que permitan evaluar la evolución funcional de los pacientes resulta fundamental. Medidas estandarizadas como el Índice de Barthel permiten cuantificar el nivel de independencia antes y después del traumatismo, y constituyen un insumo valioso para estudiar trayectorias de recuperación. Los modelos multinivel representan una estrategia estadística adecuada para analizar datos longitudinales, capturar variabilidad individual en los procesos de cambio y evaluar el efecto diferencial de los tratamientos, de acuerdo con los objetivos del estudio presentado en este informe.

# Datos

```{r, eval=F}
data$id %>% unique() %>% length()
```

Los datos fueron proporcionados por el docente a cargo de la unidad curricular. Se cuenta con información longitudinal de 327 adultos mayores que sufrieron un traumatismo de muñeca, producto de una caída. Para cada individuo se registran siete variables vinculadas a factores personales y el contexto temporal de la medición. Se excluyó un individuo que presentaba dos fracturas en años distintos sin información funcional previa suficiente para reconstruir una trayectoria longitudinal consistente.

## Variables estáticas

```{r, eval=F}
data$edad %>% summary()
```

Diversos estudios han documentado que la densidad mineral ósea disminuye progresivamente con la edad. En particular, @zhang2010epidemiology señalan que la pérdida de densidad ósea se intensifica en la sexta década de vida, lo que incrementa el riesgo a fracturas. En nuestro conjunto de datos, los individuos presentan una edad media de 83.5 años, con un rango entre 65 y 101 años, valores claramente por encima de este umbral crítico. Por lo tanto, la edad adquiere un rol clínicamente relevante en el análisis de la recuperación funcional.

Veamos la variabilidad de edades para esta muestra mediante un histograma, vemos que la mayoría de las personas que ingresaron al tratamiento tienen entre  80 y 90 años.

```{r}
data_id <- data %>% 
  distinct(id, .keep_all = TRUE)

ggplot(data_id, aes(x = edad)) +
  geom_histogram(bins = 15, fill = "steelblue", color = "black") 
```

```{r, eval=F}
(data$sexo %>% table())/nrow(data)
```

En cuanto al género, la proporción de mujeres en la muestra es considerablemente mayor (80%), lo cual es consistente con la evidencia epidemiológica: tras la menopausia, la disminución abrupta de estrógenos acelera la pérdida de densidad mineral ósea, aumentando la fragilidad del sistema musculo-esquelético y, por ende, la probabilidad de sufrir fracturas por caída [@riggs1986involutional]. Por otro lado, la literatura también muestra diferencias significativas en la recuperación funcional según el género. @dimonaco2012men encuentra en su estudio que los hombres presentan peores resultados funcionales que las mujeres, por lo que resulta pertinente incluir el género como covariable a nivel individual en los modelos.

```{r, eval=F}
(data$tratamiento %>% table())/nrow(data)
```

Respecto al tratamiento recibido, la elección entre tratamiento quirúrgico y fisioterapia tras una fractura de muñeca depende tanto de las características de la lesión como de las características clínicas del paciente. En general, las fracturas estables mediante inmovilización seguida de fisioterapia, mientras que la cirugía se reserva para fracturas inestables. En nuestra muestra, el 37% de los pacientes recibió tratamiento conservador y el 63% tratamiento quirúrgico.

```{r, eval=F}
(data$domicilio %>% table())/nrow(data)
```

Finalmente, la condición habitacional constituye un factor relevante en la recuperación funcional de adultos mayores. Vivir en el propio domicilio suele asociarse a mayor autonomía y una rutina previa más estable, lo que favorece la readquisición de habilidades motoras y funcionales. Por el contrario, residir en un hogar o institución puede reflejar una situación de mayor dependencia previa o menor movilidad, elementos que tienden a enlentecer la recuperación tras una fractura. En nuestros datos, el 69% de los pacientes residía en su domicilio y el 31% en instituciones, por lo que esta variable se incorpora como covariable a nivel individual para capturar diferencias en el nivel funcional previo y en el apoyo disponible durante el proceso de rehabilitación.

## Variables temporales

```{r}
data <- data %>% 
   mutate(momento = factor(momento,
                           levels=c('previo', 'ingreso', 
                                   '1 mes', '3 meses', 
                                   '12 meses', '24 meses')))
```

La variable que determina el tiempo donde se releva la información y le que otorga estructura longitudinal al conjunto de datos, `momentos`, establece tiempos de medición previos a la lesión, al momento de ingreso al sistema hospitalario y posteriormente a los 1, 3, 12 y 24 meses del evento, siendo las dos primeras mediciones disponibles para todos los individuos, mientras que las siguientes se registran de forma más esporádica.

```{r}
data$momento %>% table() %>% t() %>%  kable() %>%
   kable_styling(latex_options = 'HOLD_position')
```

Para estos momentos se releva la variable `barthel`.

Como se establece por @mahoney1965barthel, el índice de Barthel es un índice simple de independencia para evaluar la capacidad de un paciente con un trastorno neuro-muscular o musculo-esquelético para cuidar de sí mismo. Los valores asignados a cada ítem se basan en el tiempo y la cantidad de asistencia física real requerida si un paciente no puede realizar la actividad.

```{r plot1, warning=F, caption = 'Boxplot del índice de Barthel para diferentes momentos en relación a la lesión.', fig.height=3.5}
data %>% ggplot()+
   geom_boxplot(aes(x=momento, y=barthel, fill=momento))+
   theme(legend.position = 'none')+
   theme_bw()+scale_fill_viridis_d()
```

En la Figura @plot1 se muestra la distribución del Índice de Barthel en cada uno de los momentos de medición, con el objetivo de obtener una primera impresión de la evolución funcional de los pacientes. Se observa que, antes de la lesión, los individuos presentan niveles elevados de independencia funcional, en general por encima de 75 puntos. Tras el ingreso hospitalario, el puntaje disminuye de forma marcada, reflejando el estado físico asociado al evento. A partir del primer mes, los valores comienzan a incrementarse nuevamente, acompañando el proceso de recuperación. Entre el mes y dos años del incidente, la varianza del estado físico de los pacientes aumenta bastante, en comparación con los dos momentos del tiempo anteriores.

```{r}
b_prev <- data %>% filter(momento=='previo') %>% 
   mutate(b_prev = barthel) %>% select(id,b_prev) %>% unique()
b_ini <- data %>% filter(momento=='ingreso') %>% 
   mutate(b_ini = barthel) %>% select(id,b_ini) %>% unique()
data <- data %>% left_join(b_prev, by='id')%>% left_join(b_ini, by='id')
```

Por ultimo, la variable `recuperacion`, definida como $recuperacion = \frac{barthel_{actual}-barthel_{ingreso}}{barthel_{previo}-barthel_{ingreso}}$, se encuentra disponible para todos los momentos de medición excepto para el momento previo a la lesión dado que la expresión carece de interpretación clínica.

```{r,fig.height=3.5, caption='Trayectorias individuales de recuperación funcional para una muestra de pacientes seleccionados.'}
data %>% filter(id%in%c(1:10), momento!='previo') %>% ggplot()+
   geom_line(aes(x=momento, y=recuperacion, group = factor(id),
                 color=factor(id)))+
   labs(color='id')+
   theme_bw()+
   scale_color_viridis_d()
```


 
 _hablar trayectorias_
 
# Metodología

Al trabajar con medidas repetidas, hay varios modelos posibles, entre ellos el RM – ANOVA, el cual es una adaptación del modelo ANOVA para medidas repetidas. Este no es el que se utilizó para el presente análisis, ya que supone que los datos deben estar balanceados, y como se mencionó anteriormente, en los datos disponibles esto no sucede.

Otro modelo posible, y con el que se decidió trabajar es el Modelo de Efectos Mixtos (LME), debido a que es mucho más flexible con respecto a los supuestos y presenta varias ventajas con respecto al modelo anterior.

## Descripción de las variables 

Para la creación de modelos se establece como variable dependiente la recuperación del paciente, `recuperacion`. Previo a crear los modelos, se realizaron algunos ajustes sobre los datos:

-   Dado que al utilizar `recuperacion` como variable dependiente las observaciones de momento previo carecen de interpretación, las mismas fueron excluidas del análisis longitudinal. En su lugar se agrega una variable `b_prev` que indica el valor de índice de Barthel previo a la lesión.

```{r}
# ya se hizo antes, en datos sobre momentos para verificar como se creaba recuperacion
data <- data %>% filter(momento!='previo')
```

-   En consecuencia a lo anterior, definir el instante ingreso como momento 0 produciría una constante sin interpretación sustantiva y dificultaría la interpretación de la variabilidad entre sujetos. Es por ello que la variable `momento2` toma de referencia el primer mes posterior al ingreso y se codifica {-1, 0, 2, 11, 23} para los momentos de ingreso, 1 mes, 3 meses, 12 meses y 24 meses, respectivamente.

```{r}
data = data %>%  
   mutate(momento2 = case_when(momento == "ingreso" ~ -1,
                              momento == "1 mes" ~ 0,
                              momento == "3 meses" ~ 2,
                              momento == "12 meses" ~ 11,
                              momento == "24 meses" ~ 23,
                              TRUE ~ NA_real_))
```

-   Respecto a la edad, siguiendo la literatura que indica el umbral critico referente a la densidad osea, se decide centrar la variable respecto a 60, con el fin que la interpretación de la constante refiera a la recuperación promedio en el umbral, y varíe para cada año por sobre el mismo ($edad2 = edad-60$).

```{r}
data <- data %>% 
   mutate(edad2 = edad - 60,
          tratamiento = as.factor(tratamiento),
          domicilio = as.factor(domicilio),
          sexo = as.factor(sexo),
          id = as.factor(id))
```

_hablar de porque no incorpotrramos barthel_

Por lo que las variables a seleccionar son:

_esta raro, capaz va a en otro lado, tipo armarlo si como tabla despues de las correlaciones_

- **Recuperación**: Variable dependiente 

- **Tratamiento** : Variable categórica que indica el típo de tratamiento que es sometido el paciente luego de la lesión, esta es una variable de nivel 2 ya que este no cambia en el tiempo.


- **domicilio**: Variable dummy que indica si el individuo hizo la recuperacion en su domicilio (si) o en un centro de reahbilitación (no). Esta es una varible de nivel 1.

- **Sexo**

- **momento2** : variable que toma como referencia el primer mes luego del ingreso, la metrica temporal queda definida como: $\{-1, 0, 2, 11, 23\}$, es una variable de nivel 1 ya que esta variable cambia en el tiempo.

- **edad2** variable de edad de los individuos a la hora del ingreso , centrada en 60 años. 

- **b_ini**: Indice de Barthel al ingreso de la lesión

- **b_prev**: Indice de Barthel previo a la lesion

_nota no usamos berthel, mirar corr_

Estudio la correlacion entre la variable dependiente recuperacion en cada momento del tiempo para la variable barthel
```{r}
data |>
  group_by(momento2) |>
  summarise(r_barthel = cor(barthel,recuperacion,use = "complete.obs"))
         
```

# Modelado

Se comienza por discernir la estructura apropiada de la matriz $\pmb D$. Bajo la hipótesis nula, se asume que ningún efecto aleatorio $k$ tiene un aporte significativo al modelo (modelo lineal):

\begin{equation}
H_0) \; \pmb D_i = 
\begin{bmatrix}
\pmb D_{q\times q} & \pmb 0_{q\times k}\\
\pmb 0_{k\times q} & \pmb 0_{k\times k}
\end{bmatrix}
\end{equation}

A partir de los modelos ajustados con `lmer(REML = FALSE)`, la significación de los componentes de varianza se evalúa empleando la mezcla de distribuciones propuesta por @Stram1994.
 
Después se establecen diferentes modelos...


_Se crearon diversos modelos LME utilizando la función lmer() del paquete lme4, además se aplicó la corrección de los grados de libertad de Kenward - Roger, la cual presenta ventajas sobre la corrección Satterthwait especialmente en muestras pequeñas y datos desbalanceados._

# Resultados

## Estructura de la matriz $\pmb D$

```{r, echo=T}
mod0 <- lm(recuperacion ~ 1, data=data)
mod1 <- lmer(recuperacion ~ 1 + (1|id), data=data, REML=F)
mod2 <- lmer(recuperacion ~ 1 + (momento2|id), data=data, REML=F)
```

```{r, echo=T}
L0 <- logLik(mod0)
L1 <- logLik(mod1)
LRT <- -2*(L0 - L1)
0.5*pchisq(LRT, 1, lower.tail = FALSE)
```

El p-valor obtenido para evaluar la inclusión de contantes aleatorias indica que dichos efectos son estadísticamente significativos.

```{r, echo=T}
L2 <- logLik(mod2)
LRT <- -2*(L1 - L2)
pchisq(LRT,c(1,2),lower.tail = FALSE) |> mean()
```

Si bien la prueba sugiere que el modelo con pendiente aleatoria mejora el ajuste, el ajuste del modelo más complejo presenta un problema de _boundary (singular) fit_.

Esto se refleja en una varianza estimada de la pendiente aleatoria prácticamente nula y una correlación entre intercepto y pendiente igual a 1.00.

Bajo estas condiciones, el modelo con pendiente aleatoria no es identificable y los valores del log-likelihood utilizados en el LRT no son confiables. _cantidad obs x id muy baja_

Bajo esta problematica se evaluan los siguientes dos modelos, solo constantes aleatorias y solo pendientes aleatorias, de forma de ver que inclusion de la variable momentos2 es mas significativa:

```{r}
mod3 <- lmer(recuperacion ~ momento2 + (1|id), data=data, REML=F)
mod4 <- lmer(recuperacion ~ 1 + (0+momento2|id), data=data, REML=F)
anova(mod3,mod4)
```

En función de las pruebas realizadas y del problema de singularidad observado al intentar estimar pendientes aleatorias, se adopta como estructura aleatoria final un modelo con intercepto aleatorio y pendiente fija para `momento2`. El modelo jerárquico resultante es:

$$recuperacion_{it} = \beta_{0i} + \beta_{1i}momento2_{it} + \varepsilon_{it} \qquad i=1,2,...,327\quad t=-1,0,2,11,23$$
$$\beta_{0i}=\gamma_{00}+\eta_{0i}$$

```{r, echo=T}
mod0 <- lmer(recuperacion ~ momento2 + (1|id), data=data)
summary(mod0, ddf = "Kenward-Roger")
```


## Inclusión de covariables al modelo

Se comienza un modelo base, donde hay un intercepto aleatorio para cada paciente y una variable temporal como efecto fijo. Luego, se incorporan como efectos fijos otras variables como la edad al momento del traumatismo, el sexo y domicilio del paciente, que como se mencionó anteriormente, la literatura las identifica como variables relevantes.

```{r}
mod1 = lmer(recuperacion ~ momento2 + sexo + edad2 + domicilio + (1|id), data= data)
anova(mod0,mod1) # se acepta el modelo nuevo
summary(mod1, ddf = "Kenward-Roger")
```

Del modelo anterior, se detecta que en contradicción con lo que la literatura señalaba, el genero del paciente no es significativo para explicar la recuperación del mismo, por lo que se decide prescindir de esta variable.

_cambiar, se da a entender que el anterior tenia tratamiento_

Además, se incluye la variable tratamiento como efecto fijo, se decide incorporarla de esta forma y no como efecto aleatorio debido al objetivo que se planteó, se quiere identificar el efecto del tratamiento sobre la recuperación en si mismo, es decir, detectar si la evolución en la recuperación de los pacientes varía según el tratamiento proporcionado.

```{r}
mod2= lmer(recuperacion ~ momento2 + edad2 + domicilio + tratamiento + (1|id),data= data) #sacamos sexo y agregamos tratamineto, comparamos con mod0
anova(mod0,mod2) #aceptamos el nuevo modelo
summary(mod2, ddf = "Kenward-Roger")
```

_todo relevante_

*probamos b_prev*

```{r,eval=F, echo=T}
mod3= lmer(recuperacion ~ momento2 + edad2 + domicilio + tratamiento + b_prev + (1|id),data= data)
anova(mod2,mod3) #se acepta el nuevo modelo
summary(mod3, ddf = "Kenward-Roger")
```

*probamos b_ini*

```{r,eval=F, echo=T}
mod4= lmer(recuperacion ~ momento2 + edad2 + domicilio + tratamiento + b_prev + b_ini + (1|id),data= data)
anova(mod3,mod4) #no da nada
summary(mod4, ddf = "Kenward-Roger")
```

_comentar no da nada_

Como la pregunta que se buscaba responder es si el tratamiento tiene efectos sobre la evolución de la recuperación, además de incluir el efecto fijo del tratamiento, se decidió incorporar la interacción entre momento y tratamiento, de la cual también se desprende que su efecto no es significativo sobre la variable dependiente.

```{r,eval=F, echo=T}
mod5= lmer(recuperacion ~ momento2 + edad2 + domicilio + tratamiento + b_prev + momento2*tratamiento + (1|id),data= data)
anova(mod3,mod5) #no da nada
summary(mod5, ddf = "Kenward-Roger")
```

_comentario_

## Modelo final

$$escribirlo$$

```{r}
mod_final = mod3
summary(mod_final)
```

_insterpretar_



```{r}
data.frame(sexo=c('M', 'F'),
                                              edad2=c(85-60, 85-60),
                                              tratamiento = c('cirugía', 'fisioterapia'),
                                              domicilio=c('si','si'),
                                              momento2=c())
predict(objecto=mod_final, newdata=data.frame(sexo=c('M', 'F'),
                                              edad2=c(85-60, 85-60),
                                              tratamiento = c('cirugía', 'fisioterapia'),
                                              domicilio=c('si','si'),
                                              momento2=c()))
```








Se llegó a un modelo final, el cual permite cumplir con los objetivos planteados, sin embargo, se abre espacio a mejorar el presentado modelo, debido a que problemas como el de la matriz singular persisten.

\newpage

# Bibliografía
