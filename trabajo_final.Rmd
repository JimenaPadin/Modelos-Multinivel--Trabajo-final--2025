---
title: "Recuperacion funcional"
subtitle: |
          | Proyecto final
          | Introducción a los Modelos Multinivel
author: 
  - 'Bajac, Matías'
  - 'Padín, Jimena'
  - 'Viscailuz, Luciana'
date: "2025"
output: pdf_document
bibliography: referencias.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(readxl)
library(tidyverse)
library(rstatix)# para hacer ANOVA RM
library(GGally)
library(lme4)
library(lmerTest) #para incluir los p valores
```

*info proporcionada por el profe:*

Esta investigaci´on tiene como objetivo evaluar el efecto de dos tratamientos (fisioterapia personalizada y cirug´ıa ortop´edica) en la recuperaci´on funcional de adultos mayores que han sufrido un traumatismo de mu˜neca por ca´ıdas. Este tipo de lesi´on es com´un en personas mayores con disminuci´on de reflejos o quilibrio y puede comprometer significativamente la autonom´ıa en actividades cotidianas como la alimentaci´on, la higiene personal o el uso de dispositivos. El estudio se basa en modelos multinivel (para datos longitudinales) que permiten analizar la evoluci´on funcional de los pacientes teniendo en cuenta el tratamiento recibido, incorporando como covariables el sexo, la edad al momento del traumatismo y la condici´on habitacional (residencia en domicilio propio o en instituci´on). Se cuenta con el estado funcional medido a trav´es del ´ındice de Barthel previo a la lesi´on, en el ingreso al hospital, al mes, a los 3 meses, al a˜no y a los 2 a˜nos. A partir de estos valores se calcul´o adem´as una tasa de recuperaci´on.

```{r, echo=FALSE, include=FALSE, datos}
data <- read_xlsx('recuperacion_funcional.xlsx')

names(data)
data %>% group_by(id,domicilio) %>% summarise(n=n()) %>% filter(n>1)
```

-   sexo: variable nivel 1
-   edad: variable nivel 1 (posible centerig o movimiento por interpretacion)
-   tratamiento:
-   domicilio: no cambian de domicilio durante el tratamiento. nivel 1
-   momento: el el tiempo, ver como codificar para interpretacion de gammas
-   barthel: variable nivel 2, es relevante ver la condicion antes de la caida
-   recuperacion: nivel 2

no se si se queire hacer una logistica con variable 'alcanzo la misma agilidad que antes de la lesion' o simplemente se quiere modelar respecto a recuperacion que esta entre 0-1.

Habria que ver que hacer con la variable edad, tiene sentido centralizarla? sirve para la interpretacion de los coeficientes. edad negativa quiere decir que en el momento t tenia menos anios que la edad promedio...

ver del momento .... filtraria a partir del momento 1 mes que es donde empieza el tratamiento

# Introducción

### Análisis de los datos

Se cuenta con la información de 339 adultos mayores que sufrieron un traumatismo de muñeca, producto de una caída. A cada uno de estos individuos se les aplicó un tratamiento (cirugía o fisioterapia), y se les realizó un seguimiento de su estado funcional, medido a partir del índice de Berthel, y con este se calculó su recuperación. Se recabó información en seis momentos diferentes, previo al accidente, al momento en que se ingresó en el hospital, al mes, tres meses, al año y a los dos años.

No se obtuvo el mismo volumen de información para cada individuo, mientras que para algunos individuos si se tiene información sobre su evolución en todos los momentos de interés, para otros, solo se tiene en algunos. Además, el volumen de información a medida que avanza el tiempo, disminuye, esto es algo muy común y se suele dar por diversas razones, las principales son que los individuos decidieron abandonar el análisis, o que fallecieron.

A continuación, se presenta un gráfico para obtener una primera impresión del comportamiento de los datos frente a la variable de interés. En un principio, pareciera que la variable de interés presenta un comportamiento diferente en cada momento del tiempo. Previo al accidente, el valor suele ser bastante bueno, encontrandose por encima del 75. Luego, cuando ingresa al hospital producto del accidente, el estado físico disminuye notoriamente, para posteriormente volver a aumentar. Entre el mes y dos años del incidente, la varianza del estado físico de los pacientes aumenta bastante, en comparación con los dos momentos del tiempo anteriores.

```{r, echo=FALSE, warning=FALSE, Grafico}
ggplot(data, aes(x = momento, y = barthel, fill = momento)) +
  geom_boxplot() + scale_x_discrete(limits = c("previo", "ingreso", "1 mes", "3 meses", "12 meses", "24 meses")) +
  theme_bw() +
  theme(text = element_text(size = 15)) + labs(title="Estado funcional del paciente en diferentes momentos", x="", y="Indice de Estado físico", fill="Momento") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

# Metodologia

Al trabajar con medidas repetidas, hay varios modelos posibles, entre ellos el RM – ANOVA, el cual es una adaptación del modelo ANOVA para medidas repetidas. Este no es el que se utilizó para el presente análisis, ya que supone que los datos deben estar balanceados, y como se mencionó anteriormente, en los datos disponibles esto no sucede.

Otro modelo posible, y con el que se decidió trabajar es el Modelo de Efectos Mixtos (LME), debido a que es mucho más flexible con respecto a los supuestos y presenta varias ventajas con respecto al modelo anterior.

Previo a crear los modelos, se realizaron algunos ajustes sobre los datos. La variable momento se pasó a numérica, siendo 0 el momento previo al accidente, algunas otras se pasaron a factor, se centró la edad y se eliminó una observación que causaba diversos errores y pareciera estar incorrectamente registrada.

Se decidió centrar la variable edad, debido a que como se mencionó anteriormente, corresponde a la edad del paciente al momento del accidente, la cual varía considerablemente. Esto además permite que las interpretaciones del intercepto del modelo final sean con respecto a adultos que sufrieron el traumatismo en la edad promedio, la cual es 60 años según información recabada.

AGREGAR ALGO SOBRE LOS MOMENTOS

```{r, echo=FALSE, include=FALSE, ajustes-datos}

#data %>% summarise(var(edad), min(edad), max(edad), mean(edad))
data = data %>%  mutate(momento = case_when(momento == "previo" ~ -2,
                                            momento == "ingreso" ~ -1,
                                            momento == "1 mes" ~ 0,
                                            momento == "3 meses" ~ 2,
                                            momento == "	12 meses" ~ 11,
                                            momento == "24 meses" ~ 23,
                                                TRUE ~ NA_real_),
                        tratamiento = as.factor(tratamiento),
              domicilio = as.factor(domicilio),
                        sexo = as.factor(sexo),
              id = as.factor(id), edad = edad - mean(edad)) %>% filter(id!=53) %>%  filter(momento != -2)
#el id 53 tiene más de una medida para un mismo momento del tiempo, la edad en cada momento tampoco tiene lógica

data %>%
  group_by(momento) %>%
  get_summary_stats(barthel, type = 'mean_sd')

data %>%  group_by(momento)  %>%    summarise(r_recuperacion = cor(recuperacion,barthel))

```

## Posibles modelos

Se crearon diversos modelos LME utilizando la función lmer() del paquete lme4, además se aplicó la corrección de los grados de libertad de Kenward - Roger, la cual presenta ventajas sobre la corrección Satterthwait especialmente en muestras pequeñas y datos desbalanceados.

```{r}


## empezamos con el modelo mas basico y le vamos agregando variables hasta llegar al modelo completo  
## modelo con efecto aleatorio en la cte 

#al condicionar por id, se trabaja con que la unidad es el nivel 2 y las mediciones nivel 1, es decir, tenemos tantos grupos com individuos

#usando como recuperacion como variable dependiente
#MODELO BASE

#edad y sexo efectos fijos porque no cambian dentro del mismo id
mod0 = lmer(recuperacion ~ sexo + edad + momento + (1|id), data= data)
summary(mod0, ddf = "Kenward-Roger")
mod0 = lmer(recuperacion ~ sexo + edad + (momento|id), data= data)
summary(mod0, ddf = "Kenward-Roger")

#aparece el warning de boundary pero la varianza es mayor a 0, no se encontraron mejores resultados y se entiende que el efecto aleatorio por id debe estar. En los denás casos la varianza del intercepto daba 0 en la matriz D


#se saca sexo porque no es significativa
#tratamiento como efecto fijo porque nos interesa saber el efecto de esta variable en si misma, queremos saber si la evolución de los pacientes cambia por tratamiento, por lo cual, no lo vamos a condicionar al paciente 

mod1= lmer(recuperacion ~ edad + tratamiento + (momento|id),data= data)
summary(mod1, ddf = "Kenward-Roger")
#PARECIERA que el tratamiento significativo, es decir que si incide en la recuperación

mod2= lmer(recuperacion ~ barthel + edad +  tratamiento+ (momento|id),data= data)
summary(mod2, ddf = "Kenward-Roger")
#al incluir barthel parece que tratamiento no es significatiuvo, en realidad esto no quiere decir que no lo sea, sino que barthel explica parte de lo que antes el tratamiento, sucede una confusión porque barrthel y tratamiento son variables que están correlacionadas entre sí, dependiendo del valor de barthel el tratamiento que se le asigna
#el modelo ahora puede separar qué parte de la recuperación se debe al nivel funcional y cuál al tratamiento.
#en mod1 parecia que un tratamiento era mejor que otro, pero en realidad no es taaan así, lo que pasa es que como un tratamiento se aplica a los que están mejor puede parecer que ese tratamiento es mejor y no es así.
#el tratamiento no explica diferencias en recuperacion, quien lo hace es barthel (efecto que antes se le asignabva erroneamente a tratamiento)

mod3 <- lmer(recuperacion ~ barthel + momento + tratamiento +
                            momento:tratamiento +
                            edad + (momento | id),
             data = data)
summary(mod3, ddf = "Kenward-Roger")
#RESPUESTA A NUESTRA PREGUNTA SE HACE CON MOD3:
#momento:tratamiento da no significativo, es decir que el tratamiento no incide en la forma que evoluciona la recuperacion con el tiempo

#evoluci´on de estos pacientes seg´un el tratamiento: no cambia
#peeero:

#MODELO FINAL)?
mod4= lmer(recuperacion ~ barthel*momento  + edad + (momento|id),data= data)
summary(mod4, ddf = "Kenward-Roger")

#si se detecta que la relación entre el barthel y la recuperación cambia con el tiempo


#PROBLEMA: HAY MUCHOS BOUNDARY, NO SE VAN CON NADA :(


#ESTO TODAVÍA NO LLEGUÉ A VERLO

L0 <- logLik(mod0)
L1 = logLik(mod1)
L2= logLik(mod2)
L3 = logLik(mod3)

LRT <- -2*(L0 - L1)
LRT2  = -2*(L1-L2)
LRT3  = -2*(L2-L3)

alfa <- 0.05
anova(mod0,mod1)
anova(mod2, mod1)


qchisq(1 - 2*alfa, 1)
# p-valor
0.5*pchisq(LRT, 1, lower.tail = FALSE)
## agregar un efecto  aleatorio tiene un aporte significativo 

pchisq(LRT,c(1,2),lower.tail = FALSE) %>%  mean()

anova(mod1,mod2)
anova(mod2,mod3)

data
```

### especificaciones de los modelos

# 

# Resultados

# Bibliografía
